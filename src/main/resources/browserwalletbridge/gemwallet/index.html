<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="icon" href="data:;base64,=">
    <title>GemWallet</title>
    <script src="https://unpkg.com/@gemwallet/api@2.2.1/umd/gemwallet-api.js"></script>
    <style>
        body {
            font: 16px Helvetica, sans-serif;
        }
    </style>
</head>
<body>
<div id="waiting" style="display: visible;">
    <h4>Waiting</h4>
    <p>Waiting for the browser wallet extension to process your request. The extension should appear after a few seconds.</p>
</div>
<div id="success" style="display: none;">
    <h4>✔️Successfully completed</h4>
    <p>The action has been completed successfully. You can close this window at any time.</p>
</div>
<div id="rejected" style="display: none;">
    <h4>❌ Action rejected</h4>
    <p>The action was rejected and could not be completed. You can close this window at any time.</p>
</div>
<div id="walletApiNotAvailable" style="display: none;">
    <h4>❌ GemWallet not available</h4>
    <p>Failed to connect to wallet API. The following steps may help:</p>
    <ul>
        <li>Make sure you have the <a href="https://gemwallet.app" target="_blank">GemWallet</a> browser extension installed.</li>
        <li>Make sure you are using a browser that supports this extension. You can <a id="copy" href="#">copy</a> the browser location from the address bar and paste it into another browser.</li>
    </ul>
</div>
<div style="font-style: italic;">
    <p>Payment: <span id="amount">unknown</span></p>
</div>
</body>

<script type="text/JavaScript">

function reportSuccess(txHash) {
    report({ data: { txHash: txHash } })
}
function reportFailure(key, message) {
    console.error(key + ': ' + message)
    report({ error: { key: key, message: message } })
}
function report(json) {
    fetch(window.location, {
        method: 'POST',
        headers: {
            'Accept': 'application/json',
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(json)
    })
}

function onLoad() {
    const urlParams = new URLSearchParams(window.location.search)
    var txBase64 = urlParams.get('tx')
    if(txBase64 == null) {
        reportFailure('missing_param', 'GET param tx missing')
        return
    }
    var amount = urlParams.get('amt')
    if(amount == null) {
        reportFailure('missing_param', 'GET param amt missing')
        return
    }
    var ccy = urlParams.get('ccy')
    if(ccy == null) {
        reportFailure('missing_param', 'GET param ccy missing')
        return
    }

    var amtText = `${amount} ${ccy}`
    document.getElementById('amount').textContent = amtText
    document.title = `GemWallet: ${amtText}`;

    GemWalletApi.isConnected().then((isConnected) => {
        if(!isConnected) {
            hide('waiting')
            show('walletApiNotAvailable')
            return;
        }

        const tx = JSON.parse(atob(txBase64))
        GemWalletApi.sendPayment(tx).then((txHash) => {
            hide('waiting')
            if(txHash == null) {
                show('rejected')
                reportFailure('user_rejected', 'User rejected to sign the payment.')
            } else {
                show('success')
                reportSuccess(txHash)
            }
        });
    });
}
function hide(id) {
    document.getElementById(id).style.display = 'none';
}
function show(id) {
    document.getElementById(id).style.display = 'inline';
}

function copyUrlToClipboard() {
    navigator.clipboard.writeText(window.location);
}

document.getElementById("copy").addEventListener("click", copyUrlToClipboard, false);
window.addEventListener("load", onLoad);

</script>
</html>